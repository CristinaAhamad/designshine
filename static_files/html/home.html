<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../css/home.css">
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="../markerclusterer.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
    <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyCYfjxsTKKJXBflLGY25wU-9oB-srQTmAI",
            authDomain: "designshine-surfapp.firebaseapp.com",
            databaseURL: "https://designshine-surfapp.firebaseio.com",
            projectId: "designshine-surfapp",
            storageBucket: "designshine-surfapp.appspot.com",
            messagingSenderId: "257277932654"
          };
          firebase.initializeApp(config);
    </script>

    <script type="text/javascript">
    function setCoordinates(beachName, latitude, longitude) {
      firebase.database().ref('beach-coordinates/').remove();
      //get beach coordinates
      firebase.database().ref('beach-coordinates/' + beachName).set({
        name: beachName,
        latitude: latitude,
        longitude: longitude
      });
      console.log('successfully set coordinates');
    }


    $(document).ready(() => {
       var search = $("#searchBox");
       var items  = $(".card");
       $("#searchBox").on("keyup", function() {
        console.log("searching...");
        var g = $(this).val().toLowerCase();
        $(".card").each(function() {
            var s = $(this).text().toLowerCase();
            $(this).closest('.card')[ s.indexOf(g) !== -1 ? 'show' : 'hide' ]();
        });
      });

      const database = firebase.database();

      //append beach data
      $(".linkButton").on('click', function(event){
        console.log("clicked");

        /*Popup code*/
        var popup = document.getElementById("beachPopup");
        var span = document.getElementsByClassName("close")[0];

        var name = this.id;
        var spotNum;
        let db = database.ref('beach-ids/' + name).on('value',(snapshot) => {
          spotNum = snapshot.val();
          console.log("spot id: " + spotNum);
          apiURL = 'http://api.spitcast.com/api/spot/forecast/' + spotNum;

          let request = new XMLHttpRequest();
          request.open('GET', ('https://cors-anywhere.herokuapp.com/'+ apiURL), true);
          request.responseType = 'text';
          request.onload = function () {
            var data = JSON.parse(this.responseText);
            currCond = data[0].shape_full;

            const h1 = document.createElement('h1');
            var name = document.createTextNode(data[0].spot_name);
            h1.appendChild(name);

            const p1 = document.createElement('p');
            var shape = document.createTextNode("Current conditions: " + data[0].shape_full);
            p1.appendChild(shape);

            const meter = document.createElement('meter');
            meter.min = '0';
            meter.max = '5';
            if(data[0].shape_full.toString() == "Poor"){
              meter.value = '1';
              meter.high = '.75';
              meter.low = '.50';
              meter.optimum = '.25';
            }
            else if(data[0].shape_full.toString() == "Poor-Fair"){
              meter.value = '2';
              meter.high = '.75';
              meter.optimum = '.25';
            }
            else if(data[0].shape_full.toString() == "Fair"){
              meter.value = '3';
              meter.high = '.75';
              meter.optimum = '.25';
            }
            else if(data[0].shape_full.toString() == "Good"){
              meter.value = '4';
            }
            else if(data[0].shape_full.toString() == "Great"){
              meter.value = '5';
            }


            const p2 = document.createElement('p');
            var swell = document.createTextNode("Swell: " + data[0].shape_detail.swell);
            p2.appendChild(swell);

            const p3 = document.createElement('p');
            var tide = document.createTextNode("Tide: " + data[0].shape_detail.tide);
            p3.appendChild(tide);

            const p4 = document.createElement('p');
            var wind = document.createTextNode("Wind: " + data[0].shape_detail.wind);
            p4.appendChild(wind);

            const p5 = document.createElement('p');
            var wave = document.createTextNode("Wave size: " + data[0].size + "ft.");
            p5.appendChild(wave);

            var reviewlink = document.createElement('a');
            var linkText = document.createTextNode("See beach reviews");
            reviewlink.appendChild(linkText);
            reviewlink.href = "reviews.html";

            const beachData = document.getElementById('content');
            beachData.appendChild(h1);
            beachData.appendChild(p1);
            beachData.appendChild(meter);
            beachData.appendChild(p2);
            beachData.appendChild(p3);
            beachData.appendChild(p4);
            beachData.appendChild(p5);
            beachData.appendChild(reviewlink);

            setCoordinates(data[0].spot_name, data[0].latitude, data[0].longitude);
          }
          request.send();
        });

          popup.style.display = "block";

          span.onclick = function() {
            popup.style.display = "none";
            $('#content').empty();
          }
          window.onclick = function(event) {
            if (event.target == popup) {
              popup.style.display = "none";
              $('#content').empty();
            }
          }
        });
        /*end popup*/

        /*Reviews*/
        var html = '';
        database.ref('reviews/').once('value', (snapshot) => {
          const data = snapshot.val();
          console.log('You received some data!', Object.keys(data));
          //$('#reviews').html(<p> data[Object.keys(data)]</p>);
          (Object.keys(data)).forEach(function(id) {
            html += '<p>';
            html += data[id];
            html += '</p>';
            html += '<br><hr width="75%"/>`';
          });
          $('#reviews').html(html);
        });


      $(document).ajaxError(() => {
        $('#searchOptions').html('Error: unknown ajaxError!');
      });

    });
    </script>
  </head>

  <body>
    <div class="content">
      <div class="top">
        <h1 id="title"> Local Beaches </h1>

        <!--SEARCH BAR-->
        <div id="searchBar">
          <input id="searchBox" type="text" placeholder="Search Beaches...">
          <button id="goButton"> GO </button>
        </div>
      </div>


      <div class="container">
        <!--MAP-->
        <div class="left">
          <div id="map" style="height: 100%; width: 100%;"> </div> <br>
        </div>

        <!--BEACH LIST-->
        <div class="right">
          <!-- <h2> Beaches in La Jolla: </h2> -->
          <div id="nearbyBeaches">
            <div id="searchOptions"></div>
          </div>

          <div id="beachPopup" class="popup">
            <div class="popup-content">
              <span class="close">&times;</span>
              <div id="content">
              </div>
              <div>
              <h3>Reviews</h3>
              <div id="reviews">
              </div>
              <h3>Reviews from Google users</h3>
              <div>
                <strong>Overall Google rating:</strong>
                <span id="rating"></span>
              </div>
              <div id="googleReviews">
              </div>
              <div class="reviews"><ul class="review-list"></ul></div>
              <div id="map"></div>
              <script>
                //get google reviews
                var map, service;

                function initMap() {
                  var oceansideHarbor = new google.maps.LatLng(33.2078, -117.3950);

                  map = new google.maps.Map(document.getElementById("map"), {
                    center: oceansideHarbor,
                    zoom: 15
                  });

                  var request = {
                    location: oceansideHarbor,
                    radius: "500",
                    types: ['park']
                  };

                  service = new google.maps.places.PlacesService(map);
                  service.nearbySearch(request, searchResult);
                }

                function searchResult(results, status) {
                  if (status == google.maps.places.PlacesServiceStatus.OK) {
                    // show first result on map and request for details
                    var place = results[0];
                    var marker = new google.maps.Marker({
                      position: place.geometry.location,
                      map: map,
                      title: place.name
                    });
                    var infowindow = new google.maps.InfoWindow({
                      content: place.name
                    });
                    infowindow.open(map, marker);

                    service.getDetails({placeId: place.place_id}, function(place, status) {
                      if (status == google.maps.places.PlacesServiceStatus.OK) {
                        let rating = document.querySelector('#rating');
                        let reviewEl = document.querySelector('.review-list');

                        rating.innerHTML = place.rating;

                        for (let review of place.reviews){
                          let rev = document.createElement('div');
                          rev.innerHTML = `<div>Author: ${review.author_name}</div>
                                          <p>${review.text}</p>
                                          <div>Rating: ${review.rating} star(s)</div>
                                          <br><hr width="75%"/><br>`;
                          reviewEl.appendChild(rev);
                        }
                      }
                    });
                  }
                }
              </script>

              <!-- google reviews api -->
              <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSgPgFsM2dB9058bOAmGw_tZmheEM0qjc&callback=initMap&libraries=places"
              async defer></script>
            </div>
            </div>
        </div>
      </div>
      </div>

      <!--FOOTER MENU-->
      <footer id="footer">
        <div id="menu">
          <!--button id="searchButton"> <a href="search.html"> Search </a> </button-->
          <!--button id="homeButton"> <a href="home.html"> Home </a> </button-->
          <a href="home.html"> <img src="../images/home.png"> </a>
          <!--button id="profileButton"> <a href="profile.html"> Profile </a> </button-->
          <a href="profile.html"> <img src="../images/profile.png"> </a>
       </footer>

    </div>
    <!--end of content-->

      <script>
      // use api to get all beaches in California
      var beachesAPI;
      $.ajax({
        //url: 'https://api.coastal.ca.gov/access/v1/locations',
        url: 'http://api.spitcast.com/api/spot/all',
        type: 'GET',
        async: false,   //deprecated but at least it works now??
        success: (data) => {
          beachesAPI = data;
          console.log('successfully got data');
        }
      })
      var beaches = [];
      for (i = 0; i < beachesAPI.length; i++) {
        var beach = [];
        beach.push(beachesAPI[i]['spot_name']);
        beach.push(beachesAPI[i]['latitude']);
        beach.push(beachesAPI[i]['longitude']);
        beaches.push(beach);
      }

      //marks user's current location
      var map, infoWindow;

      function initMap() {
        //default centers map at mavericks beach in half moon bay
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.495799, lng: -122.496730},
          zoom: 6
        });
        infoWindow = new google.maps.InfoWindow;

        //marks user's geolocation
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            var locationMarker = new google.maps.Marker({
              position: pos,
              map: map,
              icon: {url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}
            });
            infoWindow.setPosition(pos);
            infoWindow.setContent('Current location');
            infoWindow.open(map, locationMarker);
            map.setCenter(pos);
            map.setZoom(12);
          }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }

          //adds markers for all beaches
          var marker, i;
          var markersArray = [];
          var label = new google.maps.InfoWindow;
          for (i = 0; i < beaches.length; i++) {
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(beaches[i][1], beaches[i][2]),
              map: map
            });
            markersArray.push(marker);

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
              return function() {
                var html = '';
                html += '<div class="infowindow-content">';
                html += beaches[i][0];
                html += '</br> <a href="weatherdata.html">'+ 'View weather details' +'</a>';
                html += '</div>';
                label.setContent(html);
                label.open(map, marker);
              }
            }) (marker, i));
          }

          //adds marker clusters for beaches
          var cluster = new MarkerClusterer(map, markersArray);

      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                                    'Error: The Geolocation service failed.' :
                                    'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }

    </script>
    <script src="../script.js"></script>
    <!-- geolocation key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSgPgFsM2dB9058bOAmGw_tZmheEM0qjc&callback=initMap"></script>

    <!-- beach locations api -->
    <script src="https://api.coastal.ca.gov/access/v1/locations" type="text/javascript"></script>
    <script src="http://api.spitcast.com/api/spot/all" type="text/javascript"></script>

    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

    <!--a href="http://magicseaweed.com"><img src="https://im-1-uk.msw.ms/msw_powered_by.png"></a-->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </body>
</html>
