<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="../css/home.css">
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="../markerclusterer.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
    <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyCYfjxsTKKJXBflLGY25wU-9oB-srQTmAI",
            authDomain: "designshine-surfapp.firebaseapp.com",
            databaseURL: "https://designshine-surfapp.firebaseio.com",
            projectId: "designshine-surfapp",
            storageBucket: "designshine-surfapp.appspot.com",
            messagingSenderId: "257277932654"
          };
          firebase.initializeApp(config);
    </script>

    <script type="text/javascript">


    $(document).ready(() => {
       var search = $("#searchBox");
       var items  = $(".card");
       $("#searchBox").on("keyup", function() {
        console.log("searching...");
        var g = $(this).val().toLowerCase();
        $(".card").each(function() {
            var s = $(this).text().toLowerCase();
            $(this).closest('.card')[ s.indexOf(g) !== -1 ? 'show' : 'hide' ]();
        });
      });

      //append beach data
      $(".linkButton").one('click', function(event){
        const database = firebase.database();

        console.log("clicked");

        var expand = document.getElementById(this.id + 'Info');

        var beachData = document.createElement('p');
        var dataText = document.createTextNode("Current conditions: Fair");
        beachData.appendChild(dataText);

        var linkToPage = document.createElement('a');
        var linkText = document.createTextNode("click here for more details");
        linkToPage.appendChild(linkText);

        var beachButton = document.getElementById(this.id);
        beachButton.appendChild(beachData);
        beachButton.appendChild(linkToPage);

        /*Popup code*/
        var popup = document.getElementById("beachPopup");
        var span = document.getElementsByClassName("close")[0];

        var name = this.id;
        var spotNum;
        let db = database.ref('beach-ids/'+name).once('value',(snapshot) => {
          spotNum = snapshot.val();
          console.log("spot id: " + spotNum);

          let request = new XMLHttpRequest();
          request.open('GET', ('http://api.spitcast.com/api/spot/forecast/' + spotNum), true);
          request.setRequestHeader('Access-Control-Allow-Headers', '*');
          request.responseType = 'text';
          request.onload = function () {
            var data = JSON.parse(this.responseText);

            console.log(data[0].spot_name);
            $('#content').append(data[0].spot_name);

            /*const p1 = document.createElement('p');
            var shape = document.createTextNode("Current conditions: " + data[0].shape_full);
            p1.appendChild(shape);

            const p2 = document.createElement('p');
            var swell = document.createTextNode("Swell: " + data[0].shape_detail.swell);
            p2.appendChild(swell);

            const p3 = document.createElement('p');
            var tide = document.createTextNode("Tide: " + data[0].shape_detail.tide);
            p3.appendChild(tide);

            const p4 = document.createElement('p');
            var wind = document.createTextNode("Wind: " + data[0].shape_detail.wind);
            p4.appendChild(wind);

            const p5 = document.createElement('p');
            var wave = document.createTextNode("Wave size: " + data[0].size + "ft.");
            p5.appendChild(wave);

            const beachData = document.getElementById('popup-content');
            beachData.appendChild(p1);
            beachData.appendChild(p2);
            beachData.appendChild(p3);
            beachData.appendChild(p4);
            beachData.appendChild(p5);*/
          }
          request.send();
        });

        linkToPage.onclick = function() {
          popup.style.display = "block";
        }
        span.onclick = function() {
          popup.style.display = "none";
        }
        window.onclick = function(event) {
          if (event.target == popup) {
            popup.style.display = "none";
          }
        }
        /*end popup*/

      var $button = $('#' + this.id),
        $text   = $('#' + this.id + 'Info'),
        visible = true;

      $button.click(function(){
      if ( visible ) {
        $text.slideUp('fast',function(){
          $text.addClass('hide')
               .slideDown(0);
        });
      } else {
        $text.slideUp(0,function(){
          $text.removeClass('hide')
               .slideDown('fast');
        });
      }
      visible = ! visible;
      });

      expand.appendChild(beachData);
      expand.appendChild(linkToPage);
    });

      $(document).ajaxError(() => {
        $('#searchOptions').html('Error: unknown ajaxError!');
      });

    });
    </script>
  </head>

  <body>
  <div class="map_container">
    <h1 id="title"> Local Beaches </h1>
    <div id="map" style="height: 400px; width: 100%;"> </div> <br>
  </div>
    <div id="searchBar">
      <input id="searchBox" type="text" placeholder="Search Beaches...">
      <button id="goButton"> GO </button>
    </div>
    <br>
    <!-- <h2> Beaches in La Jolla: </h2> -->
    <div id="nearbyBeaches">
      <div id="searchOptions">

    <!-- Pop up-->
    <div id="beachPopup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>
        <p id="content"></p>
      </div>

    </div>
  </div>

      <script>
      // use api to get all beaches in California
      var beachesAPI;
      $.ajax({
        //url: 'https://api.coastal.ca.gov/access/v1/locations',
        url: 'http://api.spitcast.com/api/spot/all',
        type: 'GET',
        async: false,   //deprecated but at least it works now??
        success: (data) => {
          beachesAPI = data;
          console.log('successfully got data');
        }
      })
      var beaches = [];
      for (i = 0; i < beachesAPI.length; i++) {
        var beach = [];
        /*if(beachesAPI[i]['SNDY_BEACH']==='Yes') {
          beach.push(beachesAPI[i]['NameMobileWeb']);
          beach.push(beachesAPI[i]['LATITUDE']);
          beach.push(beachesAPI[i]['LONGITUDE']);
          beaches.push(beach);
        }*/
        beach.push(beachesAPI[i]['spot_name']);
        beach.push(beachesAPI[i]['latitude']);
        beach.push(beachesAPI[i]['longitude']);
        beaches.push(beach);
      }

      //marks user's current location
      var map, infoWindow;

      function initMap() {
        //default centers map at mavericks beach in half moon bay
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 37.495799, lng: -122.496730},
          zoom: 6
        });
        infoWindow = new google.maps.InfoWindow;

        //marks user's geolocation
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            var locationMarker = new google.maps.Marker({
              position: pos,
              map: map,
              icon: {url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}
            });
            infoWindow.setPosition(pos);
            infoWindow.setContent('Current location');
            infoWindow.open(map, locationMarker);
            map.setCenter(pos);
            map.setZoom(12);
          }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }

          //adds markers for all beaches
          var marker, i;
          var markersArray = [];
          var label = new google.maps.InfoWindow;
          for (i = 0; i < beaches.length; i++) {
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(beaches[i][1], beaches[i][2]),
              map: map
            });
            markersArray.push(marker);

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
              return function() {
                var html = '';
                html += '<div class="infowindow-content">';
                html += beaches[i][0];
                html += '</br> <a href="weatherdata.html">'+ 'View weather details' +'</a>';
                html += '</div>';
                label.setContent(html);
                label.open(map, marker);
              }
            }) (marker, i));
          }

          //adds marker clusters for beaches
          var cluster = new MarkerClusterer(map, markersArray);

      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                                    'Error: The Geolocation service failed.' :
                                    'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }

    </script>
    <script src="../script.js"></script>
    <!-- geolocation key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSgPgFsM2dB9058bOAmGw_tZmheEM0qjc&callback=initMap"></script>

    <!-- beach locations api -->
    <script src="https://api.coastal.ca.gov/access/v1/locations" type="text/javascript"></script>
    <script src="http://api.spitcast.com/api/spot/all" type="text/javascript"></script>

    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

    <!--a href="http://magicseaweed.com"><img src="https://im-1-uk.msw.ms/msw_powered_by.png"></a-->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </body>
</html>
