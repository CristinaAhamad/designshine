<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="../css/reviews.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase.js"></script>
    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCYfjxsTKKJXBflLGY25wU-9oB-srQTmAI",
        authDomain: "designshine-surfapp.firebaseapp.com",
        databaseURL: "https://designshine-surfapp.firebaseio.com",
        projectId: "designshine-surfapp",
        storageBucket: "designshine-surfapp.appspot.com",
        messagingSenderId: "257277932654",
        appId: "1:257277932654:web:365249aeda12648e"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>

    <script src="../jquery-3.3.1.min.js"></script>

    <script type="text/javascript">
      function getCoordinates() {
        var coordinates = [];
        const database = firebase.database();
        let db = database.ref('beach-coordinates/').once('value', (snapshot) => {
          const data = snapshot.val();
          coordinates.push(Object.values(data)[0].latitude);
          coordinates.push(Object.values(data)[0].longitude);
        });
      };
      //write reviews
      $(document).ready(() => {
        getCoordinates();
        var titleID;

        const database = firebase.database();

        var favoriteButton = document.getElementById('favButton');
        var clearStar;

        //display beach name and favorite star at top of page
        database.ref('beach-coordinates/').once('value', (snapshot) => {
          const data = snapshot.val();
          //console.log('beach coordinates data:', data);
          var beachName = Object.keys(data)[0];
          var title = document.getElementById('header');
          title.innerHTML = beachName;

          titleID = document.getElementById('header').innerHTML;
          var words = titleID.split(' ').filter(function(v){return v!==''});
          if (words.length > 1) {
            titleID = titleID.replace(/ /g, '');
          }

          var newFavorites;
          database.ref('currentUser/').once('value', (snapshot) => {
            const userData = snapshot.val();
            newFavorites = userData.favorites;
            console.log(newFavorites);
            //checks favorites list to determine which color star to display on load
            if (!newFavorites.includes(beachName)) {
              favoriteButton.src = "../images/star.png";
              clearStar = true;
            }
            else {
              favoriteButton.src = "../images/yellowstar.png";
              clearStar = false;
            }
          });

          favoriteButton.onclick = function() {
            //adding the favorite
            if (clearStar) {
              newFavorites.push(beachName);
              database.ref('currentUser/').update({
                favorites: newFavorites
              })
              favoriteButton.src = "../images/yellowstar.png";
              clearStar = false;
              console.log('added favorite:', newFavorites);
            }

            //removing the favorite
            else {
              newFavorites = newFavorites.filter((keepBeach) => {
                return keepBeach != beachName;
              })
              database.ref('currentUser/').update({
                favorites: newFavorites
              })
              favoriteButton.src = "../images/star.png";
              clearStar = true;
              console.log('removed favorite:', newFavorites);
            }
          }


        });

        database.ref('currentUser/').on('value', (snapshot) => {
          const data = snapshot.val();
          var user = data.username;
          document.getElementById('greeting').innerHTML = user;
        });

        $('#submitButton').click(() => {
          if (titleID && $('#reviewBox').val()) {
            var review = {
              username: document.getElementById('greeting').innerHTML,
              review: $('#reviewBox').val()
            }
            database.ref('reviews/' + titleID).push(review);

            database.ref('reviews/' + titleID).on('value', (snapshot) => {
              const data = snapshot.val();
              console.log('reviews/'+ titleID + ':' + data);
            });
          }
          else {
            console.log('submit error');
          }
        });

        //display reviews
        var html = '';
        async function displayReviews() {
          await new Promise(done => setTimeout(() => done(), 2000));

          database.ref('reviews/' + titleID).on('value', (snapshot) => {
            const data = snapshot.val();
            console.log(data);
            if (data) {
              (Object.keys(data)).forEach(function(id) {
                html += '<h5> Author: ';
                html += data[id].username;
                html += '</h5>';
                html += '<p>';
                html += data[id].review;
                html += '</p>';
                html += '<br><hr width="75%"/>';
              });
            }
            else {
              html += 'Be the first to review this beach!';
            }
            $('#reviews').html(html);
          });
        }
        displayReviews();

        //original database code
        /*$('#submitButton').click(() => {
          const review = $('#reviewBox').val();
          console.log("review: "+review);
          database.ref('reviews/').push(review);
        });*/
        $('#logoutButton').click(() => {
          console.log('logout button clicked');
          //update users database to match currentUser
          database.ref('currentUser/').once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
              database.ref('users/' + data.username).update({
              //database.ref('currentUser/').set({
                email: data.email,
                username: data.username,
                password: data.password,
                favorites: data.favorites
              });
            }
          });
        });
      });

      //display reviews
      /*$(document).ready(() => {
        var html = '';
        const database = firebase.database();
        //original database code

        database.ref('reviews/').once('value', (snapshot) => {
          const data = snapshot.val();
          console.log('You received some data!', Object.keys(data));
          console.log(data);
          //$('#reviews').html(<p> data[Object.keys(data)]</p>);
          (Object.keys(data)).forEach(function(id) {
            html += '<p>';
            html += data[id];
            html += '</p>';
            html += '<br><hr width="75%"/>';
          });
          $('#reviews').html(html);
        });

      });*/
    </script>
  </head>

  <div>
    <img id="favButton">
    <h1 id="header"></h1>
    <div id="welcomeHeader">
      <p id="welcome"> Welcome, </p>
      <p id="greeting"></p> <br>
      <button id="logoutButton"> <a href="../index.html"> Logout</a></button>
    </div>

    <h3>Write A Review</h3>
    <p>Thoughts? Write a review of the beach you visited below!</p>
    <form>
      <textarea id="reviewBox" type="text" name="review"></textarea>
    </form>
    <br>
    <button id="submitButton"> <a href="reviews.html"> Submit </a> </button>
    <br>
    <hr/>
    <div id="reviews">
    </div>

    <h3>More reviews from Google users</h3>
    <div>
      <strong>Overall Google rating:</strong>
      <span id="rating"></span>
    </div>
    <div id="googleReviews">

    </div>

    <div class="reviews"><ul class="review-list"></ul></div>
    <div id="map"></div>

    <script>
      //get google reviews
      var coordinates = [];
      $(document).ready(() => {
        const database = firebase.database();
        let db = database.ref('beach-coordinates/').once('value', (snapshot) => {
          const data = snapshot.val();
          coordinates.push(Object.values(data)[0].latitude);
          coordinates.push(Object.values(data)[0].longitude);
          //console.log('beach-coordinates/:', data);
        });
      });

      var map, service;

      async function initMap() {
        await new Promise(done => setTimeout(() => done(), 2000));

        var beach = new google.maps.LatLng(coordinates[0], coordinates[1]);

        map = new google.maps.Map(document.getElementById("map"), {
          center: beach,
          zoom: 15
        });

        var request = {
          location: beach,
          radius: "50",
          query: 'beach'
        };

        service = new google.maps.places.PlacesService(map);
        service.textSearch(request, callback);

        function callback(results, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            var marker = new google.maps.Marker({
              map: map,
              place: {
                placeId: results[0].place_id,
                location: results[0].geometry.location
              }
            });
            var place_id = results[0].place_id;
            console.log('place id:', results[0].place_id);
            var newRequest = {
              placeId: results[0].place_id
            };

            service.getDetails(newRequest, function(place, status) {
              if (status == google.maps.places.PlacesServiceStatus.OK) {
                console.log(place.reviews);
                for (let review of place.reviews) {
                  let rating = document.querySelector('#rating');
                  let reviewEl = document.querySelector('.review-list');

                  rating.innerHTML = place.rating;
                  let rev = document.createElement('div');
                  /*rev.innerHTML = `<div>Author: ${review.author_name}</div>
                                  <p>${review.text}</p>
                                  <div>Rating: ${review.rating} star(s)</div>
                                  <br><hr width="75%"/><br>`;*/
                  rev.innerHTML = `<p>${review.text}</p>
                                  <div>Rating: ${review.rating} star(s)</div>
                                  <br><hr width="75%"/><br>`;
                  reviewEl.appendChild(rev);
                }
              }
            });
          }
        }
      }
    </script>

    <!--button> <a href="home.html"> Back </a> </button-->
    <br><br><br><br><br><br><br><br>

    <!-- google reviews api -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSgPgFsM2dB9058bOAmGw_tZmheEM0qjc&callback=initMap&libraries=places"
    async defer></script>
  </div>

  <footer id="footer">
    <div id="menu">
      <a href="home.html"> <img src="../images/home.png"> </a>
      <a href="profile.html"> <img src="../images/profile.png"> </a>
    </div>
  </footer>
</html>
